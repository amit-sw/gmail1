# User Data Dashboard - Front-End

This front-end application provides a user interface to view user-specific data stored in an AWS DynamoDB table (`UserTokens`). It uses AWS Amplify for backend integration, including authentication with Amazon Cognito and an API (GraphQL) to interact with DynamoDB.

## Features

- User authentication via Amazon Cognito (email/password).
- Display of `userId` and `refreshToken` for the authenticated user.
- Placeholder for displaying `processingStatus` (to be implemented when data is available).
- Secure access: Users can only see their own data.

## Prerequisites

- AWS Account
- Node.js and npm installed
- AWS Amplify CLI installed and configured (`npm install -g @aws-amplify/cli`, then `amplify configure`)

## Setup Instructions

Follow these steps to deploy and run this front-end application in your AWS account.

### 1. Initialize Amplify Project

1.  **Download the code:**
    If you haven't already, place `index.html`, `style.css`, and `app.js` into a new project directory.

2.  **Navigate to your project directory:**
    ```bash
    cd your-project-directory
    ```

3.  **Initialize Amplify:**
    ```bash
    amplify init
    ```
    - Follow the prompts. Choose your preferred AWS profile, default editor, and settings for a JavaScript app (e.g., `javascript` framework, `react` or `none` for source/distribution if prompted, as this is a plain JS app).

### 2. Add Authentication

1.  **Add Cognito Authentication:**
    ```bash
    amplify add auth
    ```
    - Select `Default configuration` or customize as needed (e.g., `Email` for sign-in mechanism).
    - After configuration, Amplify will set up a Cognito User Pool.

2.  **Push changes to the cloud:**
    ```bash
    amplify push
    ```
    - This will create the Cognito resources in your AWS account.
    - After the push, Amplify will generate an `aws-exports.js` file (or update it) in your project's source directory (e.g., `src/`). **You will need to copy the configuration from this `aws-exports.js` file into the `awsconfig` object at the top of `app.js`**.
    Alternatively, if you set up a `src` directory and place `app.js` there, Amplify might handle the import automatically if you structure `app.js` as a module. For this vanilla JS setup, manual copy or including `aws-exports.js` via a script tag is common.

    **Example `aws-exports.js` content to copy into `app.js`:**
    ```javascript
    // aws-exports.js (auto-generated by Amplify)
    const awsmobile = {
        "aws_project_region": "us-east-1",
        "aws_cognito_identity_pool_id": "us-east-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "aws_cognito_region": "us-east-1",
        "aws_user_pools_id": "us-east-1_xxxxxxxxx",
        "aws_user_pools_web_client_id": "xxxxxxxxxxxxxxxxxxxxxxxxxx",
        "oauth": {},
        // ... other configurations like AppSync if API is added
    };
    export default awsmobile;
    ```
    **In `app.js`, replace the placeholder `awsconfig` with this content:**
    ```javascript
    // At the top of app.js
    const awsconfig = { // Paste content from your aws-exports.js here
        "aws_project_region": "us-east-1", // Replace with your actual values
        "aws_cognito_identity_pool_id": "...",
        "aws_cognito_region": "...",
        "aws_user_pools_id": "...",
        "aws_user_pools_web_client_id": "...",
        "oauth": {},
        // "aws_appsync_graphqlEndpoint": "...", // This will be added after `amplify add api`
        // "aws_appsync_region": "...",
        // "aws_appsync_authenticationType": "AMAZON_COGNITO_USER_POOLS"
    };
    Amplify.configure(awsconfig);
    ```

### 3. Add API for DynamoDB

The `UserTokens` table stores `userId` and `refreshToken`. We need an API to access it.

1.  **Add GraphQL API:**
    ```bash
    amplify add api
    ```
    - Select `GraphQL`.
    - Provide an API name (e.g., `UserTokenAPI`).
    - For authorization, choose `Amazon Cognito User Pool` (using the auth resource you just created).
    - When asked if you have an annotated GraphQL schema, select `No`.
    - Choose a schema template. `Single object with fields (e.g., “Todo” model)` is a good starting point.
    - Open the generated schema file (e.g., `amplify/backend/api/<yourAPIName>/schema.graphql`).

2.  **Define the GraphQL Schema:**
    Replace the content of `schema.graphql` with the following. This schema defines a `UserToken` type and uses the `@auth` directive to ensure users can only access their own records. The `ownerField: "userId"` assumes your DynamoDB `UserTokens` table has a primary key or an attribute named `userId` that matches the Cognito user's `username` or `sub`.

    ```graphql
    type UserToken @model
      @auth(rules: [
        { allow: owner, ownerField: "userId", operations: [read] }
      ]) {
      userId: String! @primaryKey # Assumes userId is the primary key and matches Cognito username/sub
      refreshToken: String
      processingStatus: String # Add this when the field is available in DynamoDB
    }
    ```
    *   **Important Note on `userId`**: The `ownerField: "userId"` in `@auth` means that the value in the `userId` attribute of your `UserToken` items in DynamoDB *must* match the Cognito user's `username` (if username sign-in is used) or their `sub` attribute. When new records are created in `UserTokens` by your backend, ensure the `userId` field is populated with the correct Cognito identifier. If your `UserTokens` table uses a different field for the user identifier that Cognito provides (e.g. if it's named `owner` or `cognitoUsername`), adjust the `ownerField` in the schema accordingly.
    *   The `@primaryKey` directive on `userId` indicates it's the primary key for the DynamoDB table. If your table has a different primary key, adjust the schema. Amplify will provision a DynamoDB table based on this schema if one doesn't exist, or try to use an existing one if the names match.

3.  **Push API changes to the cloud:**
    ```bash
    amplify push
    ```
    - Confirm the changes. This will:
        - Create an AWS AppSync GraphQL API.
        - Create a DynamoDB table named `UserToken-<somehash>` (if it doesn't exist, based on the schema) or link to an existing one if you configured it.
        - Generate client-side code for interacting with the API.
    - After the push, `aws-exports.js` will be updated with AppSync endpoint details. **Ensure these are also copied into the `awsconfig` object in `app.js`**.

    ```javascript
    // Update awsconfig in app.js with AppSync details from aws-exports.js
    const awsconfig = {
        // ... Cognito settings from before ...
        "aws_appsync_graphqlEndpoint": "https://YOUR_APPSYNC_ENDPOINT/graphql",
        "aws_appsync_region": "YOUR_APPSYNC_REGION",
        "aws_appsync_authenticationType": "AMAZON_COGNITO_USER_POOLS"
    };
    Amplify.configure(awsconfig);
    ```

### 4. Add Hosting

1.  **Add Hosting with Amplify Console:**
    ```bash
    amplify add hosting
    ```
    - Select `Hosting with Amplify Console (Managed hosting with custom domains, Continuous deployment)`.
    - Choose `Manual deployment`.

2.  **Publish to Amplify Console:**
    ```bash
    amplify publish
    ```
    - This will build and deploy your `index.html`, `style.css`, and `app.js` files.
    - It will output a URL where you can access your application (e.g., `https://<branch>.<appid>.amplifyapp.com`).

### 5. Application Code (`app.js`)

The provided `app.js` is designed to:
- Configure Amplify with your `aws-exports.js` details.
- Use `Amplify.Auth` for sign-in/sign-out.
- Use `Amplify.API.graphql` to query the `UserToken` data for the authenticated user.
- The GraphQL query in `app.js` is:
  ```javascript
  const query = `
      query GetUserToken($userId: String!) {
        getUserToken(userId: $userId) {
          userId
          refreshToken
          # processingStatus # Uncomment when this field is added
        }
      }
  `;
  ```
  Amplify automatically generates queries like `getUserToken` based on your schema. The `userId` variable passed to this query should be the Cognito `username` or `sub` of the authenticated user.

## How Data is Fetched and Displayed

1.  **Authentication:** The user signs in using the Amplify UI component, which interacts with your Cognito User Pool.
2.  **User Identification:** After successful login, `Amplify.Auth.currentAuthenticatedUser()` retrieves the user's details, including their `username` (or `sub` attribute).
3.  **API Call:** The `fetchUserData(currentUserId)` function in `app.js` makes a GraphQL query to the AppSync API.
    - The query `getUserToken(userId: $currentUserId)` requests the `UserToken` item where the `userId` field matches the authenticated user's ID.
    - The `@auth` rule (`{ allow: owner, ownerField: "userId", ... }`) in `schema.graphql` ensures that AppSync only returns data if the `userId` in the DynamoDB item matches the identity of the caller (from the Cognito JWT token).
4.  **Display:** The fetched `userId` and `refreshToken` are displayed on the page.

## Future: Displaying `processingStatus`

When you add a `processingStatus` attribute to your `UserTokens` DynamoDB table and your GraphQL schema:

1.  **Update DynamoDB:**
    - Ensure your backend processes populate the `processingStatus` field in the `UserTokens` table for each user.

2.  **Update GraphQL Schema:**
    - Modify `amplify/backend/api/<yourAPIName>/schema.graphql`:
      ```graphql
      type UserToken @model
        @auth(rules: [
          { allow: owner, ownerField: "userId", operations: [read] }
        ]) {
        userId: String! @primaryKey
        refreshToken: String
        processingStatus: String # Ensure this line is present and not commented out
      }
      ```
    - Push the API changes:
      ```bash
      amplify push
      ```

3.  **Modify Front-End (`app.js`):**
    - **Uncomment `processingStatus` in the GraphQL query:**
      In `app.js`, within the `fetchUserData` function, modify the `query` string:
      ```javascript
      const query = `
          query GetUserToken($userId: String!) {
            getUserToken(userId: $userId) {
              userId
              refreshToken
              processingStatus # Make sure this line is uncommented
            }
          }
      `;
      ```
    - **Update the display logic:**
      Still in `fetchUserData`, find the section where data is displayed:
      ```javascript
      if (userTokenData) {
          refreshTokenElement.textContent = userTokenData.refreshToken;
          // Update this line:
          processingStatusElement.textContent = userTokenData.processingStatus || 'Not yet available.';
      } else {
          // ...
          processingStatusElement.textContent = 'N/A'; // Or appropriate message
      }
      ```
    - **Update initial/logout state for processingStatusElement (optional but good practice):**
      Ensure `processingStatusElement.textContent` is reset to 'Not yet available.' or similar during logout or if a user is not signed in, as is already done for other fields.

4.  **Re-publish the front-end:**
    If you made changes to `app.js` locally:
    ```bash
    amplify publish
    ```

This will update your live application to fetch and display the new `processingStatus` field.
The `index.html` already has a placeholder: `<p><strong>Processing Status:</strong> <span id="processing-status">Not yet available.</span></p>`. The JavaScript changes will populate this span.
